<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaMaster - Processador de Áudio e Vídeo</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [activeTab, setActiveTab] = useState('upload');
            const [files, setFiles] = useState([]);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [downloadUrl, setDownloadUrl] = useState('');
            const [downloadFormat, setDownloadFormat] = useState('mp3');
            const [processingStatus, setProcessingStatus] = useState('');
            const [splitDuration, setSplitDuration] = useState(60);
            const [convertFormat, setConvertFormat] = useState('mp3');

            // Limpar arquivos ao atualizar a página
            useEffect(() => {
                window.addEventListener('beforeunload', () => {
                    axios.post('/clear-files');
                });
                return () => {
                    axios.post('/clear-files');
                };
            }, []);

            // Upload de arquivo
            const handleFileUpload = async (e) => {
                const file = e.target.files[0] || e.dataTransfer.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    setUploadProgress(0);
                    const res = await axios.post('/upload', formData, {
                        onUploadProgress: (progressEvent) => {
                            const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            setUploadProgress(percent);
                        },
                    });
                    setFiles([...files, { name: file.name, id: res.data.id, duration: res.data.duration }]);
                    setUploadProgress(100);
                } catch (err) {
                    alert('Erro ao fazer upload: ' + err.response?.data?.error || err.message);
                }
            };

            // Download de vídeo de redes sociais
            const handleSocialDownload = async () => {
                try {
                    setProcessingStatus('Baixando...');
                    const res = await axios.post('/download-social', {
                        url: downloadUrl,
                        format: downloadFormat,
                    });
                    window.location.href = res.data.url;
                    setProcessingStatus('Download concluído!');
                } catch (err) {
                    setProcessingStatus('Erro: ' + err.response?.data?.error || err.message);
                }
            };

            // Melhoria de áudio
            const handleEnhanceAudio = async (fileId) => {
                try {
                    setProcessingStatus('Melhorando áudio...');
                    const res = await axios.post('/enhance-audio', { fileId });
                    window.location.href = res.data.url;
                    setProcessingStatus('Melhoria concluída!');
                } catch (err) {
                    setProcessingStatus('Erro: ' + err.response?.data?.error || err.message);
                }
            };

            // Divisão de áudio
            const handleSplitAudio = async (fileId) => {
                try {
                    setProcessingStatus('Dividindo áudio...');
                    const res = await axios.post('/split-audio', { fileId, duration: splitDuration });
                    setFiles(files.map(f => f.id === fileId ? { ...f, segments: res.data.segments } : f));
                    setProcessingStatus('Divisão concluída!');
                } catch (err) {
                    setProcessingStatus('Erro: ' + err.response?.data?.error || err.message);
                }
            };

            // Conversão de formato
            const handleConvert = async (fileId) => {
                try {
                    setProcessingStatus('Convertendo...');
                    const res = await axios.post('/convert', { fileId, format: convertFormat });
                    window.location.href = res.data.url;
                    setProcessingStatus('Conversão concluída!');
                } catch (err) {
                    setProcessingStatus('Erro: ' + err.response?.data?.error || err.message);
                }
            };

            // Download de arquivo individual
            const handleDownload = async (fileId, segment) => {
                try {
                    const res = await axios.post('/download-file', { fileId, segment });
                    window.location.href = res.data.url;
                } catch (err) {
                    alert('Erro ao baixar: ' + err.response?.data?.error || err.message);
                }
            };

            // Download de todos os arquivos em ZIP
            const handleDownloadAll = async () => {
                const zip = new JSZip();
                for (const file of files) {
                    if (file.segments) {
                        for (const [index, segment] of file.segments.entries()) {
                            const res = await axios.get(`/file/${file.id}/${segment}`, { responseType: 'blob' });
                            zip.file(`${file.name}_segment_${index + 1}.${segment.split('.').pop()}`, res.data);
                        }
                    } else {
                        const res = await axios.get(`/file/${file.id}`, { responseType: 'blob' });
                        zip.file(file.name, res.data);
                    }
                }
                const content = await zip.generateAsync({ type: 'blob' });
                saveAs(content, 'processed_files.zip');
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-blue-500 to-purple-600 text-white">
                    <header className="p-6 text-center">
                        <h1 className="text-4xl font-bold">MediaMaster</h1>
                        <p className="mt-2 text-lg">Converta, baixe, divida e melhore seus áudios e vídeos</p>
                    </header>
                    <nav className="flex justify-center space-x-4 p-4 bg-white/10">
                        {['upload', 'social', 'process', 'files'].map(tab => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-4 py-2 rounded ${activeTab === tab ? 'bg-blue-700' : 'bg-blue-500'} hover:bg-blue-600`}
                            >
                                {tab === 'upload' ? 'Upload' : tab === 'social' ? 'Download Social' : tab === 'process' ? 'Processamento' : 'Meus Arquivos'}
                            </button>
                        ))}
                    </nav>
                    <main className="container mx-auto p-6">
                        {activeTab === 'upload' && (
                            <section className="bg-white/20 p-6 rounded-lg shadow-lg">
                                <h2 className="text-2xl font-semibold mb-4">Upload de Arquivo</h2>
                                <div
                                    className="border-2 border-dashed border-gray-300 p-6 text-center"
                                    onDrop={handleFileUpload}
                                    onDragOver={e => e.preventDefault()}
                                >
                                    <p>Arraste e solte seu arquivo aqui ou</p>
                                    <input type="file" onChange={handleFileUpload} className="mt-2" />
                                    <p className="text-sm mt-2">Formatos: MP3, WAV, FLAC, AAC, OGG, M4A, WMA, MP4, AVI, MOV, etc. (máx. 1h)</p>
                                </div>
                                {uploadProgress > 0 && (
                                    <div className="mt-4">
                                        <p>Fazendo upload... {uploadProgress}%</p>
                                        <div className="w-full bg-gray-200 rounded">
                                            <div className="bg-blue-600 h-2 rounded" style={{ width: `${uploadProgress}%` }}></div>
                                        </div>
                                    </div>
                                )}
                            </section>
                        )}
                        {activeTab === 'social' && (
                            <section className="bg-white/20 p-6 rounded-lg shadow-lg">
                                <h2 className="text-2xl font-semibold mb-4">Download de Redes Sociais</h2>
                                <input
                                    type="text"
                                    value={downloadUrl}
                                    onChange={e => setDownloadUrl(e.target.value)}
                                    placeholder="URL do vídeo"
                                    className="w-full p-2 mb-4 text-black rounded"
                                />
                                <select
                                    value={downloadFormat}
                                    onChange={e => setDownloadFormat(e.target.value)}
                                    className="w-full p-2 mb-4 text-black rounded"
                                >
                                    <option value="mp3">MP3 (Áudio)</option>
                                    <option value="wav">WAV (Áudio)</option>
                                    <option value="mp4">MP4 (Vídeo)</option>
                                </select>
                                <button
                                    onClick={handleSocialDownload}
                                    className="bg-green-500 px-4 py-2 rounded hover:bg-green-600"
                                >
                                    Baixar
                                </button>
                                <p className="mt-4">Plataformas: YouTube, TikTok, Instagram, Twitter, Kwai, Facebook</p>
                            </section>
                        )}
                        {activeTab === 'process' && (
                            <section className="bg-white/20 p-6 rounded-lg shadow-lg">
                                <h2 className="text-2xl font-semibold mb-4">Processamento</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <h3 className="text-xl mb-2">Melhoria de Áudio</h3>
                                        <select
                                            onChange={e => handleEnhanceAudio(e.target.value)}
                                            className="w-full p-2 mb-4 text-black rounded"
                                        >
                                            <option value="">Selecione um arquivo...</option>
                                            {files.map(file => (
                                                <option key={file.id} value={file.id}>{file.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <h3 className="text-xl mb-2">Divisão de Áudio</h3>
                                        <select className="w-full p-2 mb-4 text-black rounded">
                                            <option value="">Selecione um arquivo...</option>
                                            {files.map(file => (
                                                <option key={file.id} value={file.id}>{file.name}</option>
                                            ))}
                                        </select>
                                        <input
                                            type="number"
                                            value={splitDuration}
                                            onChange={e => setSplitDuration(e.target.value)}
                                            placeholder="Duração do segmento (segundos)"
                                            className="w-full p-2 mb-4 text-black rounded"
                                        />
                                        <button
                                            onClick={() => handleSplitAudio(document.querySelector('select').value)}
                                            className="bg-blue-500 px-4 py-2 rounded hover:bg-blue-600"
                                        >
                                            Dividir
                                        </button>
                                    </div>
                                    <div>
                                        <h3 className="text-xl mb-2">Conversão de Formato</h3>
                                        <select className="w-full p-2 mb-4 text-black rounded">
                                            <option value="">Selecione um arquivo...</option>
                                            {files.map(file => (
                                                <option key={file.id} value={file.id}>{file.name}</option>
                                            ))}
                                        </select>
                                        <select
                                            value={convertFormat}
                                            onChange={e => setConvertFormat(e.target.value)}
                                            className="w-full p-2 mb-4 text-black rounded"
                                        >
                                            <option value="mp3">MP3</option>
                                            <option value="wav">WAV</option>
                                            <option value="flac">FLAC</option>
                                            <option value="aac">AAC</option>
                                            <option value="ogg">OGG</option>
                                            <option value="mp4">MP4</option>
                                            <option value="avi">AVI</option>
                                            <option value="mov">MOV</option>
                                        </select>
                                        <button
                                            onClick={() => handleConvert(document.querySelector('select').value)}
                                            className="bg-blue-500 px-4 py-2 rounded hover:bg-blue-600"
                                        >
                                            Converter
                                        </button>
                                    </div>
                                </div>
                                <p className="mt-4">Status: {processingStatus}</p>
                                {files.some(f => f.segments) && (
                                    <div className="mt-4">
                                        <button
                                            onClick={handleDownloadAll}
                                            className="bg-green-500 px-4 py-2 rounded hover:bg-green-600 mr-2"
                                        >
                                            Baixar Todos (ZIP)
                                        </button>
                                    </div>
                                )}
                            </section>
                        )}
                        {activeTab === 'files' && (
                            <section className="bg-white/20 p-6 rounded-lg shadow-lg">
                                <h2 className="text-2xl font-semibold mb-4">Meus Arquivos</h2>
                                <ul>
                                    {files.map(file => (
                                        <li key={file.id} className="mb-2">
                                            <p>{file.name} ({file.duration}s)</p>
                                            {file.segments ? (
                                                file.segments.map((segment, index) => (
                                                    <button
                                                        key={index}
                                                        onClick={() => handleDownload(file.id, segment)}
                                                        className="bg-green-500 px-2 py-1 rounded hover:bg-green-600 mr-2"
                                                    >
                                                        Baixar Segmento {index + 1}
                                                    </button>
                                                ))
                                            ) : (
                                                <button
                                                    onClick={() => handleDownload(file.id)}
                                                    className="bg-green-500 px-2 py-1 rounded hover:bg-green-600"
                                                >
                                                    Baixar
                                                </button>
                                            )}
                                        </li>
                                    ))}
                                </ul>
                            </section>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>